(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{184:function(t,a,s){"use strict";s.r(a);var n=s(6),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h5",{attrs:{id:"系统及软件版本："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#系统及软件版本："}},[t._v("#")]),t._v(" 系统及软件版本：")]),t._v(" "),s("ul",[s("li",[t._v("ubuntu 18 LTS")]),t._v(" "),s("li",[t._v("jenkins 2.176")]),t._v(" "),s("li",[t._v("docker 18.09.7")])]),t._v(" "),s("h5",{attrs:{id:"jenkins-配置及插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-配置及插件"}},[t._v("#")]),t._v(" jenkins 配置及插件")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("Docker plugin")])]),t._v(" "),s("li",[s("p",[t._v("Docker build step")]),t._v(" "),s("p",[s("em",[t._v("因为墙的原因，jenkins下载插件很慢需要更换国内站点，这里用的清华的jenkins站点。但在插件管理-高级中修改升级站点并不会生效，需要到jenkins配置文件中修改，解决方案如下：")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改 /var/lib/jenkins/update/default.json 执行")]),t._v("\n\n:s/http:"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/updates.jenkins-ci.org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/download"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/plugins/https:"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/mirrors.tuna.tsinghua.edu.cn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/jenkins"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/plugins/g\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启即可")]),t._v("\n")])])])])]),t._v(" "),s("h5",{attrs:{id:"docker-配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-配置"}},[t._v("#")]),t._v(" docker 配置")]),t._v(" "),s("ul",[s("li",[t._v("配置阿里云仓库（官方docker hub速度很慢）"),s("a",{attrs:{href:"https://cr.console.aliyun.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("阿里云docker容器镜像服务"),s("OutboundLink")],1)])]),t._v(" "),s("h5",{attrs:{id:"jenkins部署步骤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jenkins部署步骤"}},[t._v("#")]),t._v(" jenkins部署步骤")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("新建一个maven项目")])]),t._v(" "),s("li",[s("p",[t._v("配置源码管理，这里使用的github仓库，配置了webhook用于提交代码触发自动构建。")])]),t._v(" "),s("li",[s("p",[t._v("maven 构建配置")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://blog.zhuangzexin.top:8082/images/2020/03/27/image.png",alt:"image.png"}})]),t._v(" "),s("p",[s("em",[t._v("这里使用的 docker:build 是maven安装了 docker镜像生成的插件，也可以不安装，那样就需要自己用命令构建镜像")])]),t._v(" "),s("p",[s("em",[t._v("maven docker 插件为:")])]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("plugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("com.spotify"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("docker-maven-plugin"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("0.4.11"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("configuration")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("imageName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("${docker.image.prefix}/${project.artifactId}"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("imageName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("imageTags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("imageTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("${project.version}"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("imageTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("imageTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("latest"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("imageTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("imageTags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dockerDirectory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("src/main/docker"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dockerDirectory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("resource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("targetPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("/"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("targetPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("directory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("${project.build.directory}"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("directory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("${project.build.finalName}.jar"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("resource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("configuration")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("plugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[s("em",[t._v("docker.image.prefix 自己配置 例如配置banksy  project.artifactId 是test，则生成的镜像名为 banksy/test")])]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/spotify/docker-maven-plugin",target:"_blank",rel:"noopener noreferrer"}},[t._v("插件地址"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[t._v("构建镜像并推送到远程仓库")]),t._v(" "),s("p",[s("em",[t._v("使用shell")])]),t._v(" "),s("p",[s("img",{attrs:{src:"http://blog.zhuangzexin.top:8082/images/2020/03/27/image8de90075cf8c6afa.png",alt:"image8de90075cf8c6afa.png"}})]),t._v(" "),s("p",[s("em",[t._v("shell 命令：")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'================开始推送镜像================'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker login -u yourusername -p yourpassword  registry.cn-shanghai.aliyuncs.com\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker tag banksy/test registry.cn-shanghai.aliyuncs.com/myimage:latest\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker push registry.cn-shanghai.aliyuncs.com/myimage:latest\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'================结束推送镜像================'")]),t._v("\n")])])]),s("p",[s("em",[t._v("此处使用shell 会遇到两个坑")])]),t._v(" "),s("ol",[s("li",[s("p",[t._v("无法使用sudo，因为jenkins是使用的jenkins用户来执行的shell，因而需要为jenkins配置sudo权限,使用root账户进入 /etc 目录执行")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /etc\nvisudo\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加如下内容")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Allow members of group sudo to execute any command")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加内容如下")]),t._v("\njenkins "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ALL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ALL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" NOPASSWD: ALL\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ctrl+O 写入文件")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://stackoverflow.com/questions/51222996/docker-login-fails-on-a-server-with-no-x11-installed",target:"_blank",rel:"noopener noreferrer"}},[t._v("docker login fails on a server with no X11 installed"),s("OutboundLink")],1),t._v(" 执行")])])]),t._v(" "),s("p",[s("em",[t._v("In a nutshell (from https://github.com/docker/compose/issues/6023)")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" gnupg2 pass \ngpg2 --full-generate-key\n\n")])])]),s("p",[t._v("This generates a you a gpg2 key. After that's done you can list it with")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("gpg2 -k\n")])])]),s("p",[t._v("Copy the key id (from the line labelled "),s("code",[t._v("[uid]")]),t._v(") and do")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("pass init "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"whatever key id you have"')]),t._v("\n")])])]),s("p",[s("em",[t._v("使用docker plugin插件")])]),t._v(" "),s("p",[s("img",{attrs:{src:"http://blog.zhuangzexin.top:8082/images/2020/03/27/image2db23fa7a7e5409c.png",alt:"image2db23fa7a7e5409c.png"}})])]),t._v(" "),s("li",[s("p",[t._v("目标机器上pull仓库并执行")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://blog.zhuangzexin.top:8082/images/2020/03/27/image54284e3a8fcc509a.png",alt:"image54284e3a8fcc509a.png"}})]),t._v(" "),s("p",[s("em",[t._v("bash 命令：")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/usr/bin/env bash")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'================开始拉取镜像================'")]),t._v("\ndocker login -u yourusername -p yourpassword  registry.cn-shanghai.aliyuncs.com\ndocker push registry.cn-shanghai.aliyuncs.com/myimage:latest\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker run -d   --name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("banksy-test -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":8081 --restart"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("always registry.cn-shanghai.aliyuncs.com/myimage:latest\n\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'================结束远程启动================'")]),t._v("\n")])])])])]),t._v(" "),s("h5",{attrs:{id:"结束"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#结束"}},[t._v("#")]),t._v(" 结束")]),t._v(" "),s("p",[t._v("以上还有优化空间，push完后删除镜像，目标机器先删除老的镜像再构建等。还有可以使用docker plugin的登陆，不然需要在shell使用明文密码，使用明文密码需要安装 "),s("strong",[t._v("gnupg2 pass")]),t._v(" 。")])])}),[],!1,null,null,null);a.default=e.exports}}]);